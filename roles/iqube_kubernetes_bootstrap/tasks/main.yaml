---

- name: Create IQube context directory for kubernetes-bootstrap
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  loop:
  - /root/iqube-kubernetes-bootstrap

- name: Pull IQube deployment artifact for kubernetes-bootstrap
  ansible.builtin.command:
    cmd: "apptainer pull {{ item }}"
    chdir: "/usr/local/share/iqube"
    creates: "/usr/local/share/iqube/{{ item | basename | replace(':', '_') }}.sif"
  loop:
  - "{{ kubernetes_bootstrap }}"

- name: Configure iqube.yaml for kubernetes-bootstrap
  ansible.builtin.template:
    src: iqube-kubernetes-bootstrap.yaml
    dest: /root/iqube-kubernetes-bootstrap/iqube.yaml
    mode: 0644
    force: false

- name: Initialize kubernetes-bootstrap IQube context
  ansible.builtin.command:
    cmd: "iqube new --context kubernetes-bootstrap /usr/local/share/iqube/{{ kubernetes_bootstrap | basename | replace(':', '_') }}.sif"
    chdir: /root/iqube-kubernetes-bootstrap
    creates: /root/iqube-kubernetes-bootstrap/config

- name: allow kubernetes-bootstrap to use default storage location
  community.general.sefcontext:
    target: '/var/lib/fuzzball/compute/bootstrap(/.*)?'
    setype: container_file_t
    state: present
  notify: restorecon /var/lib/fuzzball/compute
